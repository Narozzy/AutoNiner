

{% extends 'base_temp.html' %}

{% block content %}
    <head>
        <!-- Font Awesome -->
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

        <!-- Moment.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js" integrity="sha256-VBLiveTKyUZMEzJd6z2mhfxIqz3ZATCuVMawPZGzIfA=" crossorigin="anonymous"></script>

        <!-- Bootstrap -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <!-- Tempus Dominus Bootstrap 4 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css" integrity="sha256-XPTBwC3SBoWHSmKasAk01c08M6sIA5gF5+sRxqak2Qs=" crossorigin="anonymous" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js" integrity="sha256-z0oKYg6xiLq3yJGsp/LsY9XykbweQlHl42jHv2XTBz4=" crossorigin="anonymous"></script>

        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!-- d3.js -->
        <script src="https://d3js.org/d3.v3.js"></script>

        <!-- Load multiselect -->
        <link href="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/css/bootstrap-multiselect.css" rel="stylesheet" type="text/css" />
        <script src="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/js/bootstrap-multiselect.js" type="text/javascript"></script>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <link href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
        <link href="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/css/bootstrap-multiselect.css" rel="stylesheet" type="text/css" />
        <script src="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/js/bootstrap-multiselect.js" type="text/javascript"></script>
    </head>

        <div class='mx-auto card shadow w-75 border-secondary m-4 '>
            <div class="card-header">Heatmap for door traffic</div>
            <div class="card-body text-secondary">

                {% if max_range and min_range %}

                    <p>This task contains data starting from {{min_range}} until {{max_range}}</p>

                    <div class="container p-3 my-3" style="padding:20px; width:90%;">
                        <div class="row" >
                            <div class="col-sm-3" >
                                <label for="yearSelector">Year:</label>
                                <select id="yearSelector" multiple="multiple">
                                    {% for item in year_options %}

                                        <option value={{ item }}>{{ item }}</option>

                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-3" >
                                <label for="monthSelector">Month:</label>
                                <select id="monthSelector" multiple="multiple">
                                    <option value="0">January</option>

                                    <option value="1">February</option>

                                    <option value="2">March</option>

                                    <option value="3">April</option>

                                    <option value="4">May</option>

                                    <option value="5">June</option>

                                    <option value="6">July</option>

                                    <option value="7">August</option>

                                    <option value="8">September</option>

                                    <option value="9">October</option>

                                    <option value="10">November</option>

                                    <option value="11">December</option>
                                </select>
                            </div>
                            <div class="col-sm-3" >
                                <label for="daySelector">Day:</label>
                                <select id="daySelector" multiple="multiple">
                                    <option value="0">Sunday</option>

                                    <option value="1">Monday</option>

                                    <option value="2">Tuesday</option>

                                    <option value="3">Wednesday</option>

                                    <option value="4">Thursday</option>

                                    <option value="5">Friday</option>

                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div class="col-sm-3" >
                                <label for="hourSelector">Hour:</label>
                                <select id="hourSelector" multiple="multiple">
                                    <option value="0">12 am</option>

                                    <option value="1">1 am</option>

                                    <option value="2">2 am</option>

                                    <option value="3">3 am</option>

                                    <option value="4">4 am</option>

                                    <option value="5">5 am</option>

                                    <option value="6">6 am</option>

                                    <option value="7">7 am</option>

                                    <option value="8">8 am</option>

                                    <option value="9">9 am</option>

                                    <option value="10">10 am</option>

                                    <option value="11">11 am</option>

                                    <option value="12">12 pm</option>

                                    <option value="13">1 pm</option>

                                    <option value="14">2 pm</option>

                                    <option value="15">3 pm</option>

                                    <option value="16">4 pm</option>

                                    <option value="17">5 pm</option>

                                    <option value="18">6 pm</option>

                                    <option value="19">7 pm</option>

                                    <option value="20">8 pm</option>

                                    <option value="21">9 pm</option>

                                    <option value="22">10 pm</option>

                                    <option value="23">11 pm</option>
                                </select>
                            </div>
                        </div>
                        <br />
                        <input class="btn btn-primary" type="button" id="btnget" value="Get Selected Values" />
                    </div>

                    <div id="heatmap_vis" data-hours='{{array_vis}}'></div>

                {% else %}
                    <p>There is no data associated to this task, please <a href="/template/{{id}}">upload</a> data for this task to create a visualization.</p>
                {% endif %}
            </div>
        </div>

<script>

// condense objects by day and time data
var condenseSharedDayTime = function( unCondenseddata ){

	let condensedMap = new Map();

	unCondenseddata.forEach(function (item, index) {

	  let dayHourStr = "d:" + item.day + "h:" + item.hour;

	  if ( condensedMap.has( dayHourStr ) )
	  {
		let tempItem = jQuery.extend({}, condensedMap.get( dayHourStr ));

		tempItem.coffee_c = parseInt( tempItem.coffee_c ) + parseInt( item.coffee_c );
		tempItem.north_c = parseInt( tempItem.north_c ) + parseInt( item.north_c );
		tempItem.south_c = parseInt( tempItem.south_c ) + parseInt( item.south_c );

		if (   tempItem.year.indexOf(item.year) == -1 ) // check and update if year not in object
		{
			tempItem.year += ", " + item.year;
		}

		//update entry
		condensedMap.set( dayHourStr, tempItem );
	  }
	  else
	  {
		condensedMap.set( dayHourStr, jQuery.extend({}, item ) );
	  }
	});

	let condensedArray = Array.from( condensedMap.values() );

	return condensedArray;
}

// ------------ heat map section ------------- //

// set the dimensions and margins of the heatmap graph
var marginHeatMap = { top: 50, right: 0, bottom: 100, left: 40 },
  widthHeatMap = 960 - marginHeatMap.left - marginHeatMap.right,
  heightHeatMap = 430 - marginHeatMap.top - marginHeatMap.bottom,
  gridSizeHeatMap = Math.floor(widthHeatMap / 24),
  legendElementWidth = gridSizeHeatMap*2,
  buckets = 12,
  colorsHeatMap = ["#eef8e9","#dbf1ce","#c7e9b4","#b3e19a","#a0da7f","#8cd265","#79ca4b","#67bc37","#58a22f","#4a8728","#3c6d20","#2d5318"],
  mydays = ["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],
  myHours = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"],
  months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

// append the svg object to the heatmap portion of the page
var svgHeatMap = d3.select("#heatmap_vis").append("svg")
  .attr("width", widthHeatMap + marginHeatMap.left + marginHeatMap.right)
  .attr("height", heightHeatMap + marginHeatMap.top + marginHeatMap.bottom)
  .append("g")
  .attr("transform", "translate(" + marginHeatMap.left + "," + marginHeatMap.top + ")");

var dayLabels = svgHeatMap.selectAll(".dayLabel")
  .data(mydays)
  .enter().append("text")
	.text(function (d) { return d; })
	.attr("x", 0)
	.attr("y", function (d, i) { return i * gridSizeHeatMap; })
	.style("text-anchor", "end")
	.attr("transform", "translate(-6," + gridSizeHeatMap / 1.5 + ")")
	.attr("class", function (d, i) { return ((i >= 0 && i <= 4) ? "dayLabel mono axis axis-workweek" : "dayLabel mono axis"); });

var timeLabels = svgHeatMap.selectAll(".timeLabel")
  .data(myHours)
  .enter().append("text")
	.text(function(d) { return d; })
	.attr("x", function(d, i) { return i * gridSizeHeatMap; })
	.attr("y", 0)
	.style("text-anchor", "middle")
	.attr("transform", "translate(" + gridSizeHeatMap / 2 + ", -6)")
	.attr("class", function(d, i) { return ((i >= 7 && i <= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });

// ---------- End Heat Map Section ------------ //

// ---------- Bar Graph Section -------------- //

// set dimensions for bar graphs
var marginBarGraph = {top: 30, right: 30, bottom: 70, left: 60},
    width = 460 - marginBarGraph.left - marginBarGraph.right,
    height = 400 - marginBarGraph.top - marginBarGraph.bottom;

//Read the data for the graphs
var pageData = $('#heatmap_vis').data('hours');

// heat map drawing function
var drawHeatMap = function(dataIn) {

	// check for empty json data
	if (dataIn == "")
	{
	  var emptyDataString = '[{ "hour":"0", "day":"5", "month":"' + months[0] + '", "year":"No Data",  "north_c":"1",  "south_c":"0", "coffee_c":"0" }]';
	  dataIn = $.parseJSON(emptyDataString);
	}

	// condense all instances that share weeks and hours
	let tempData = condenseSharedDayTime( dataIn );

	var colorScale = d3.scale.quantile()
	  .domain([0, buckets, d3.max(tempData, function (d) { var dTotal = parseInt(d.north_c) + parseInt(d.south_c) + parseInt(d.coffee_c); return dTotal; })])
	  .range(colorsHeatMap);

	// add the squares

	var cards = svgHeatMap.selectAll(".hour")
		.data(tempData, function(d) {return d.day +':'+d.hour;});

	cards.enter().append("g")

	cards.append("rect")
		.attr("x", function(d) { return d.hour * gridSizeHeatMap; })
		.attr("y", function(d) { return d.day * gridSizeHeatMap; })
		.attr("rx", 4)
		.attr("ry", 4)
		.attr("class", "hour bordered")
		.attr("width", gridSizeHeatMap)
		.attr("height", gridSizeHeatMap)
		.style("fill", colorsHeatMap[0])
		.on("mouseover", mouseoverHeatMap)
		.on("mousemove", mousemoveHeatMap)
		.on("mouseleave", mouseleaveHeatMap);

	cards.selectAll("rect").transition().duration(1000)
		.style("fill", function(d) { var dTotal = parseInt(d.north_c) + parseInt(d.south_c) + parseInt(d.coffee_c); return colorScale(dTotal);});

	cards.exit().remove();

	// add legend

	var legend = svgHeatMap.selectAll(".legend")
		.data( colorScale.quantiles(), function(d) { return d; });

	legend.enter().append("g")
	  .attr("class", "legend");

	legend.append("rect")
	.attr("x", function(d, i) { return legendElementWidth * i; })
	.attr("y", heightHeatMap)
	.attr("width", legendElementWidth)
	.attr("height", gridSizeHeatMap / 2)
	.style("fill", function(d, i) { return colorsHeatMap[i]; });

	legend.append("text")
	.attr("class", "mono")
	.text(function(d) { return "â‰¥ " + Math.round(d); })
	.attr("x", function(d, i) { return legendElementWidth * i; })
	.attr("y", heightHeatMap + gridSizeHeatMap);

	legend.exit().remove();
}

var drawBarGraph = function( dataIn ) {


}

// create a tooltip for heatmap
var tooltip = d3.select("#heatmap_vis")
.append("div")
.style("opacity", 0)
.attr("class", "tooltip")
.style("background-color", "white")
.style("border", "solid")
.style("border-width", "2px")
.style("border-radius", "5px")
.style("padding", "5px")
.style("width", "200px")

// Three function that change the tooltip when user hover / move / leave a cell for heatmap
var mouseoverHeatMap = function(d) {
tooltip.style("opacity", 1)
}
var mousemoveHeatMap = function(d) {
var dTotal = parseInt(d.north_c) + parseInt(d.south_c) + parseInt(d.coffee_c);
tooltip
  .html( " Year: " + d.year + "<br>" + " Day: " + mydays[d.day] + "<br>" + " Hour: " + d.hour + "<br>" + "Traffic In: " + dTotal)
  .style("left", (d3.mouse(this)[0]+70) + "px")
  .style("top", (d3.mouse(this)[1] + 150) + "px")
}
var mouseleaveHeatMap = function(d) {
tooltip.style("opacity", 0)
}

// start up default
drawHeatMap( "" );

// multi-select dropdown

$('#monthSelector').multiselect({
	includeSelectAllOption: true,
	maxHeight: 200
});
$('#daySelector').multiselect({
	includeSelectAllOption: true,
	maxHeight: 200

});
$('#hourSelector').multiselect({
	includeSelectAllOption: true,
	maxHeight: 200,
	enableFiltering: true
});
$('#yearSelector').multiselect({
	includeSelectAllOption: true,
	maxHeight: 200,
	enableFiltering: true
});

// handle filter updates for all graphs
$('#btnget').click( function () {

    let yearSelected = $("#yearSelector option:selected");
	let monthSelected = $("#monthSelector option:selected");
	let daySelected = $("#daySelector option:selected");
	let hourSelected = $("#hourSelector option:selected");

	let yearArr = [];
	let monthArr = [];
	let dayArr = [];
	let hourArr = [];

	let selectedData = [];

	yearSelected.each( function () {
        yearArr.push( $(this).val() );
    });

	monthSelected.each(function () {
		monthArr.push(months[$(this).val()]);
	});

	daySelected.each(function () {
		dayArr.push($(this).val());
	});

	hourSelected.each(function () {
		hourArr.push($(this).val());
	});

	selectedData =  pageData.filter(function(d){ return yearArr.includes( d.year ) && monthArr.includes( d.month ) && dayArr.includes( d.day ) && hourArr.includes( d.hour ); }) ;

	// clear previous squares
	drawHeatMap( "" );

	// update with selected location
	drawHeatMap( selectedData );
});

</script>
<style>

body {
  margin-top: 30px;
  font-size: 1.4rem;
  font-family: 'Source Sans Pro', sans-serif;
  font-weight: 400;
  fill: #696969;
  text-align: center;
}

.timeLabel, .dayLabel {
		font-size: 1.6rem;
		fill: #AAAAAA;
		font-weight: 300;
	}

#nav-container {
  display: flex;
  justify-content: center;
  cursor: pointer;
}

#nav-container .left {
  margin-right: 20px;
}

#nav-container .right {
  margin-left: 20px;
}

rect.bordered {
stroke: #E6E6E6;
stroke-width:2px;
}

text.mono {
font-size: 9pt;
font-family: Consolas, courier;
fill: #000;
}

.dropdown-menu {
width: 200px;
}
</style>

{% endblock content %}